name: DevSecOps Master Pipeline

on:
  push:
    branches: [ "uat" ]

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: my-devops-cluster

permissions:
  id-token: write
  contents: read
  issues: write
  checks: write
  actions: write

jobs:
  # ------------------------------------------------------------------
  # STAGE 1: Infrastructure
  # ------------------------------------------------------------------
  deploy-infra:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC Ready)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy ECR and SSM
        uses: aws-actions/aws-cloudformation-github-deploy@v1
        with:
          name: DevOpsBaseInfra
          template: infra/cloudformation/01-ecr.yaml
          no-fail-on-empty-changeset: "1"

  # ------------------------------------------------------------------
  # STAGE 2: Build & Security Scan
  # ------------------------------------------------------------------
  build-and-secure:
    needs: deploy-infra
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [product-api, shop-ui]

    steps:
      - uses: actions/checkout@v4

      - name: Snyk Security Scan
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          file: services/${{ matrix.service }}/requirements.txt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Docker Image
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          set -e
          cd services/${{ matrix.service }}
          IMAGE="$REGISTRY/${{ matrix.service }}:${{ github.sha }}"
          docker build -t $IMAGE .
          docker push $IMAGE

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ steps.login-ecr.outputs.registry }}/${{ matrix.service }}:${{ github.sha }}'
          format: table
          severity: CRITICAL,HIGH
          exit-code: 0

  # ------------------------------------------------------------------
  # STAGE 3: Deploy to EKS
  # ------------------------------------------------------------------
  deploy-k8s:
    needs: build-and-secure
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update KubeConfig
        run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Deploy Namespace
        run: kubectl apply -f infra/k8s/namespace.yaml

      - name: Deploy Microservices
        run: |
          set -e
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_REGISTRY="${ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          
          sed -i "s|REPO_URI_PLACEHOLDER|$ECR_REGISTRY/product-api|g" infra/k8s/product-api.yaml
          sed -i "s|REPO_URI_PLACEHOLDER|$ECR_REGISTRY/shop-ui|g" infra/k8s/shop-ui.yaml
          sed -i "s|IMAGE_TAG_PLACEHOLDER|${{ github.sha }}|g" infra/k8s/*.yaml
          
          kubectl apply -f infra/k8s/product-api.yaml
          kubectl apply -f infra/k8s/shop-ui.yaml
          kubectl apply -f infra/k8s/hpa.yaml

      - name: Force Rollout Restart
        run: |
          kubectl rollout restart deployment/shop-ui -n devops-demo
          kubectl rollout status deployment/shop-ui -n devops-demo

  # ------------------------------------------------------------------
  # STAGE 4: DAST (OWASP ZAP)
  # ------------------------------------------------------------------
  dast-test:
    needs: deploy-k8s
    runs-on: ubuntu-latest
    env:
      TARGET_URL: "placeholder"

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get LoadBalancer URL
        run: |
          aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
          echo "Waiting for LoadBalancer..."
          sleep 25
          LB_URL=$(kubectl get svc shop-ui-lb -n devops-demo -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          echo "TARGET_URL=http://$LB_URL" >> $GITHUB_ENV

      - name: Fix File Permissions
        run: chmod -R 777 .

      # -------------------------------------------------------------
      # ZAP BASELINE SCAN — SAFE MODE (NO ARTIFACT BUG)
      # -------------------------------------------------------------
      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: ${{ env.TARGET_URL }}
          cmd_options: "-a"
          fail_action: false
          allow_issue_writing: false

      # -------------------------------------------------------------
      # MANUAL ARTIFACT UPLOAD — STABLE
      # -------------------------------------------------------------
      - name: Upload ZAP Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-results
          path: |
            report_json.json
            report_md.md
            report_html.html
            
  # ------------------------------------------------------------------
  # STAGE 5: Monitoring (Prometheus + Grafana + CloudWatch)
  # ------------------------------------------------------------------
  monitoring-stack:
    needs: deploy-k8s
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      # AWS Auth
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # Connect to EKS
      - name: Configure kubeconfig
        run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      # Install Helm
      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      # Add Helm repos
      - name: Add Helm Repositories
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update

      # Install Prometheus Stack
      - name: Install Prometheus (kube-prometheus-stack)
        run: |
          helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
            --namespace monitoring \
            --create-namespace

      # Install Grafana
      - name: Install Grafana
        run: |
          helm upgrade --install grafana grafana/grafana \
            --namespace monitoring \
            --set adminPassword=admin123 \
            --set service.type=LoadBalancer

      # ------------------------------------------------------------------
      # FIXED: CloudWatch Agent Installation
      # Added 4 extra 'sed' commands to fix the "invalid map key" error
      # ------------------------------------------------------------------
      - name: Install CloudWatch Container Insights
        run: |
          # 1. Download the official QuickStart manifest
          curl -O https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/quickstart/cwagent-fluent-bit-quickstart.yaml

          # 2. Replace Standard Variables
          sed -i "s|{{cluster_name}}|${{ env.EKS_CLUSTER_NAME }}|g" cwagent-fluent-bit-quickstart.yaml
          sed -i "s|{{region_name}}|${{ env.AWS_REGION }}|g" cwagent-fluent-bit-quickstart.yaml
          
          # 3. Replace NEW Variables with QUOTES (Fixes the crash)
          # We use \"value\" to ensure they are treated as Strings, not Numbers/Booleans
          sed -i "s|{{http_server_toggle}}|\"On\"|g" cwagent-fluent-bit-quickstart.yaml
          sed -i "s|{{http_server_port}}|\"2020\"|g" cwagent-fluent-bit-quickstart.yaml
          sed -i "s|{{read_from_head}}|\"Off\"|g" cwagent-fluent-bit-quickstart.yaml
          sed -i "s|{{read_from_tail}}|\"On\"|g" cwagent-fluent-bit-quickstart.yaml
          

          # 4. Apply the modified file
          kubectl apply -f cwagent-fluent-bit-quickstart.yaml


      # Verify Pods
      - name: Verify Monitoring Pods
        run: kubectl get pods -n monitoring
        
      - name: Verify CloudWatch Pods
        run: kubectl get pods -n amazon-cloudwatch
